
```{r}

Month_Year = function( x ){ yearmonth( zoo::as.yearmon( x , "%Y%m") ) }

week_Year = function( x ){ tsibble::yearweek( x ) }

reporting.plots = function( df , 
                        wrap_nchar = 25 , 
                        .period = Month , 
                        base_text = 8 ,
                        n_col = 3 ,
                        show.last.month = FALSE 
                        ){
  
  .period = rlang::enquo( .period )
  
  datas = unique( df$dataSet )
  datas = datas[ ! datas %in% 'NA_NA' ]

  plots =   
    
    map( datas , ~ {
      
      d = df %>% 
                 filter( dataSet %in% .x 
                           
                           ) %>%
           
           
         
          mutate( 
                value = as.integer( value ) 
                ) %>%
            
          pivot_wider( 
            id_cols =  c( dataSet.id , dataSet, period ) ,
            names_from  = reporting , values_from = value 
            ) %>% 
            
          mutate( 
        
            Month = Month_Year( period ) ,
            month = factor( lubridate::month( Month ) ) ,
            Year = factor( lubridate::year( Month ) )  ,
            Reporting = ACTUAL_REPORTS / EXPECTED_REPORTS , 
            `Reporting On Time` = ACTUAL_REPORTS_ON_TIME / EXPECTED_REPORTS 
            
              ) %>%
              
          filter( Year %in% 2018:2020 ) %>%
      
          pivot_longer( cols = starts_with( 'Report' ) , 
                        names_to = 'Reporting' , values_to = 'Percent' 
                        
                        ) 
    
                 
    g = 
      
      ggplot(  ) +
                 
      geom_line( 
          data = d %>% filter( Month <=  Month_Year( Sys.Date() - months( 2 ) )    ) ,
          aes( x = month , y = Percent , group = Year , color = Year ) , 
          size = 1
        )  + 
      
                 
      scale_y_percent( NULL ,
                       expand = expansion(mult=c(0,0.1) ) ,
                       limits = c( 0 , NA )
      
      ) +
      
      scale_color_ipsum() +
        
        facet_grid( Reporting ~ . ) +
        
        labs( title = .x ,
              subtitle = 'Percentage of facilities **Reporting** and **Reporting on Time**') +
        
        md_theme_minimal( base_size = base_text  ) 
    
          # last months
      if ( show.last.month ){ 
         g = g  +
           
           geom_line( 
          
              data = d %>% filter(Month >=  Month_Year( Sys.Date() - months( 2 ) )   ) , 
              aes( x = month , y = Percent , group = Year  ) ,
              color = 'grey' , size = 1
          )
      }
    
      return( g )
    
    }
  
  )
  
  patch.plots = reduce( plots, `+`)
  
  patch.plots = patch.plots + 
       
      plot_layout( ncol = n_col , guides = "keep") 
  
  return( patch.plots )
  
}
```

<!-- Data files -->
```{r , include=FALSE}
dir = '../dataDictionary/dhis2_dictionary/Formulas/Burkina Faso/'

dir.files = list.files( dir )

files.facility = dir.files[ grepl( 'Formation' , dir.files) & !grepl( 'rda' , dir.files) ]

formula_number = str_split( files.facility , "_") %>% map_chr(2) %>%
  str_extract(. ,  "[0-9]+") %>% as.integer()

files.facility = files.facility[ order( formula_number )]

files.national = dir.files[ grepl( 'Nation' , dir.files) & !grepl( 'rda' , dir.files)  ]

data.files = c( files.national, files.facility ) 

sf = readRDS( paste0( dir , 'Burkina Faso_geoFeatures_2020-06-02.rds' ))
st_crs( sf ) <- 4326

sf. = readRDS( paste0( dir , 'newOUS.rds') )
st_crs( sf.) <- 4326
```


```{r}
i = {{i}}

formula = str_split( files.facility[ i ] , "_")[[1]][2]

```

# Reporting Rates by Dataset Form 

For each dataset (e.g. data entry form), there are two plots.  Both plots are year over year style, showing the previous two years (brown and green lines) and the current year (black line). 

The top plot is the percent of expected reports that was reported.  Typically, some percentage of clinics report their data *on time*, roughly two weeks after end of month, while the rest take many more weeks or months. 

One way check this is by looking at Reporting On Timeâ€”did the same number of facilities report on time that usually report on time?  If there were a systemic problem, we would expect there to be fewer facilities reporting on time.

The bottom plot is the percent of the expected reports that was reported *on time*. These charts shows that the usual number of facilities reported on time, suggesting that there is no underlying change in reporting. 

Because data is typically incomplete for the preceding month, it is omitted from this chart.

```{r fig.width= 8 , dpi=200 }

  file = files.national[ i ] 

  saved.file.name = paste0( dir, file )

# CHR/CHU 07 Diagnostic et traitement du Paludisme  is duplicated?!
  d.national = readRDS( saved.file.name ) %>%
    filter( dataSet.id != 'LLo9ok0sB91'  ) 
  
  
  # displaying value or raw????
  reporting.plots( d.national , base_text = 5 , show.last.month = FALSE  ) 

  
```
  

